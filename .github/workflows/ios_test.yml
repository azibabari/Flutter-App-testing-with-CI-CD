name: TestIos

on: [push]

jobs:
  test:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v2

    - name: Setup Flutter
      uses: subosito/flutter-action@v1
      with:
        channel: 'stable'

    - name: Install CocoaPods
      run: sudo gem install cocoapods

    - name: Build iOS app
      run: |
        flutter clean
        flutter pub get
        flutter run

    - name: Start iOS Simulator
      run: |
        sudo xcode-select --switch /Applications/Xcode_13.2.1.app/Contents/Developer
        xcrun simctl boot "iPhone 12"
        xcrun simctl bootstatus "iPhone 12"

    - name: Install Maestro
      run: curl -Ls "https://get.maestro.mobile.dev" | bash

    - name: Install Facebook IDB tool
      run: |
        brew tap facebook/fb
        brew install facebook/fb/idb-companion

    - name: Run tests
      run: maestro test filename.yml
      env:
        FLUTTER_VERSION: stable # Use a specific version of Flutter, if needed

    - name: Shutdown iOS Simulator
      if: always()
      run: xcrun simctl shutdown "iPhone 12"
